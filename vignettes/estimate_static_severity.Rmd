---
title: "Calculating a static, delay-adjusted estimate of disease severity"
output:
  bookdown::html_vignette2:
    fig_caption: yes
    code_folding: show
pkgdown:
  as_is: true
bibliography: resources/library.json
link-citations: true
vignette: >
  %\VignetteIndexEntry{Calculating a static, delay-adjusted estimate of disease severity}
  %\VignetteEncoding{UTF-8}
  %\VignetteEngine{knitr::rmarkdown}
editor_options: 
  chunk_output_type: console
---

```{r setup, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>",
  dpi = 300,
  fig.width = 5, fig.height = 3
)
```

It is important to understand the severity of a disease in terms of the case fatality risk in order to respond appropriately to an outbreak.
During an outbreak there is often a delay between cases being reported, and the outcomes (hospitalisation, death, etc.) of those cases being known.

Knowing the distribution of these delays from previous outbreaks of the same (or similar) diseases, and accounting for them, can be useful in getting better estimates of disease severity.

This vignette demonstrates how to calculate a static (not time-varying) estimate of the severity of an outbreak using methods outlined in @nishiura2009, and implemented in _cfr_.

::: {.alert .alert-warning}
New to calculating disease severity using _cfr_? You might want to see the ["Get started" vignette first](cfr.html).
:::

::: {.alert .alert-primary}
## Use case {-}

We want a static estimate of the severity of an outbreak, using a method that uses a time series of cases, infections or hospitalisations (as appropriate) and deaths, _while correcting for the delay in reporting the outcomes of cases_.
:::

::: {.alert .alert-secondary}
### What we have {-}

* A time-series of cases, hospitalisations or some other proxy for infections over time;
* A time-series of deaths;
* A delay distribution, describing the probability an individual will die $t$ days after they were initially infected.

The first two elements are expected to be included in a dataframe with the columns "dates", "cases", and "deaths".

The delay distribution is expected to be specified as an object of the class `<epidist>` from the package [_epiparameter_](https://epiverse-trace.github.io/epiparameter/).
:::

First load _cfr_ and packages to access and plot data.

```{r, message = FALSE, warning=FALSE, eval = TRUE}
library(cfr)
library(epiparameter)
library(incidence2)
library(dplyr)
library(scales)
library(ggplot2)
```

## Severity of the 1976 Ebola Outbreak

We use case and death incidence data from the 1976 Ebola outbreak in the Democratic the overall severity of Ebola. We do so as though we were roughly half way through the outbreak, emulating when the methods presented in this package are arguably their most useful. 

### Plotting the raw data

First of all, we load the raw data.

```{r message = FALSE, warning = FALSE, eval = TRUE}
data("ebola1976")
```

Then, we plot the case incidence data.

```{r fig.cap ="Incidence of cases over time, taken from the 1976 Ebola outbreak in the Democratic Republic of the Congo. Data retrieved from within the *cfr* package.", class.source = 'fold-hide'}
ggplot(ebola1976) +
  geom_step(
    aes(
      x = date, y = cases
    ),
    colour = "steelblue"
  ) +
  scale_x_date(
    date_labels = "%d-%b-%Y"
  ) +
  labs(
    x = "Date", y = "Cases"
  ) +
  coord_cartesian(
    expand = FALSE
  ) +
  theme_classic() +
  theme(legend.position = "top")
```

Lastly, we plot the death data.

```{r fig.cap = "Incidence of deaths over time from the same dataset as Figure 1.", class.source = 'fold-hide'}
ggplot(ebola1976) +
  geom_step(
    aes(
      x = date, y = deaths
    ),
    colour = "brown"
  ) +
  scale_x_date(
    date_labels = "%d-%b-%Y"
  ) +
  labs(
    x = "Date", y = "Deaths"
  ) +
  coord_cartesian(
    expand = FALSE
  ) +
  theme_classic() +
  theme(legend.position = "top")
```

We will focus on the roughly the first half of this dataset. We do so by
subsetting the data so that we only include days before the 30th September 1976,
using `dplyr::filter()`.

```{r, message = FALSE, warning = FALSE, eval = TRUE}
df_ebola_subset <- filter(ebola1976, date <= "1976-09-30")
```

### The delay distribution

For this example, given that we are using case data and detection of a case is well-approximated by symptom onset, we use the distribution describing the delay between onset-to-death.

As such, we retrieve such a distribution from the literature [@barry2018] using the `epidist_db()` function from the _epiparameter_ package with the following command:

```{r}
onset_to_death_ebola <- epidist_db(
  disease = "Ebola Virus Disease",
  epi_dist = "onset_to_death",
  author = "Barry_etal",
  single_epidist = TRUE
)
```

### Estimating incidence of cases (or similar time-series) with a known death outcome

The function `known_outcomes()` from the _cfr_ package can estimate the number of cases which have a known death outcome over time.

The resulting data frame contains two new columns, "known_outcomes", for the number of known death outcomes expected for each day, and "u_t", the under-reporting factor that estimates what proportion of cases have not been reported, given the estimated number of known death outcomes.

```{r}
# calculate known death outcomes
df_known_outcomes_ebola <- known_outcomes(
  data = df_ebola_subset,
  epidist = onset_to_death_ebola
)

# visualise head of data frame
head(df_known_outcomes_ebola)
```


```{r fig.cap = "The same case and death time series for the 1976 Ebola outbreak in D.R.C., with estimated known death outcomes included.", class.source = 'fold-hide'}
# plot cases and known death outcomes as separate layers
ggplot(df_known_outcomes_ebola) +
  geom_step(
    aes(
      x = date, y = cases,
      colour = "Cases"
    )
  ) +
  geom_step(
    aes(
      x = date, y = known_outcomes,
      colour = "Known death outcomes"
    )
  ) +
  scale_colour_manual(
    values = c(
      "Cases" = "steelblue",
      "Known death outcomes" = "darkgreen"
    ),
    name = NULL
  ) +
  scale_x_date(
    date_labels = "%d-%b-%Y"
  ) +
  theme(
    legend.position = "top"
  ) +
  labs(
    x = "Date", y = "No. of individuals"
  ) +
  coord_cartesian(
    expand = FALSE
  ) +
  theme_classic() +
  theme(legend.position = "top")
```

### Estimating the naive and corrected CFR

Once we calculate the proportion of cases with known death outcomes, we apply the proportion to the number of cases to correct for the delay between onset-to-death.
We do so by using the function `cfr_static()` from the _cfr_ package.
This function estimates the proportion of known death outcomes over time, and uses the estimate to correct the naive severity estimate.

Users can correct for delays by passing an epidemiological delay distribution as an optional argument, called `epidist`.
The delay distribution must be appropriate to the severity measure being calculated, and must be an `<epidist>` object.
These can be created using `epiparameter::epidist()`, or loaded from a parameter library (see below).

When no delay distribution is provided, the function calculates a naive severity estimate, which does not adjust for delays and is simply the total number of deaths in the dataset divided by the total number of cases.

```{r message = FALSE, warning = FALSE, eval = TRUE}
# calculating the naive CFR
cfr_static(
  data = df_ebola_subset
)

# calculating the corrected CFR
cfr_static(
  df_ebola_subset,
  epidist = onset_to_death_ebola
)
```

## Severity of the COVID-19 pandemic in the U.K.

We now perform a similar analysis with all of the same steps, with data taken from the ongoing COVID-19 epidemic in the U.K.
For brevity, we describe the steps without methodological explanations throughout this example.

We get the data from the [_incidence2_ package](https://cran.r-project.org/package=incidence2) (but note that it was originally made available in the  [_covidregionaldata_](https://github.com/epiforecasts/covidregionaldata) package which is no longer available on CRAN; see @palmer2021).

### Plotting the raw data

We subset the data so that we focus on just the first year of the COVID-19 outbreak in the U.K.
We do so, as the CFR changed dramatically as a result of the vaccination campaign.
The static severity calculations we are performing in this vignette are not able to deal with changes in severity over time.

We change some default column names to match those required by _cfr_ and subset the data.frame to focus on the first year of the pandemic in the U.K.

```{r, message = FALSE, warning = FALSE, eval = TRUE}
df_covid_uk <- covidregionaldataUK

df_covid_uk <- aggregate(
  data = df_covid_uk,
  x = cbind(cases_new, deaths_new) ~ date,
  FUN = function(x) sum(x, na.rm = TRUE)
)

df_covid_uk <- rename(
  df_covid_uk,
  cases = cases_new, deaths = deaths_new
)

df_covid_uk_subset <- filter(df_covid_uk, date <= "2020-12-31")
```

Then, we plot the subsetted case data.

```{r, fig.cap = "Incidence of cases over time for the ongoing COVID-19 outbreak in the U.K.", class.source = 'fold-hide'}
ggplot(df_covid_uk_subset) +
  geom_step(
    aes(
      x = date, y = cases
    ),
    colour = "steelblue"
  ) +
  scale_x_date(
    date_labels = "%d-%b-%Y"
  ) +
  scale_y_continuous(
    labels = comma
  ) +
  labs(
    x = "Date", y = "Cases"
  ) +
  coord_cartesian(
    expand = FALSE
  ) +
  theme_classic() +
  theme(legend.position = "top")
```

Then, we plot the subsetted death data.

```{r, fig.cap = "Incidence of deaths over time for the ongoing COVID-19 outbreak in the U.K.", class.source = 'fold-hide'}
ggplot(df_covid_uk_subset) +
  geom_step(
    aes(
      x = date, y = deaths
    ),
    colour = "brown"
  ) +
  scale_x_date(
    date_labels = "%d-%b-%Y"
  ) +
  scale_y_continuous(
    labels = comma
  ) +
  labs(
    x = "Date", y = "Deaths"
  ) +
  coord_cartesian(
    expand = FALSE
  ) +
  theme_classic() +
  theme(legend.position = "top")
```

### The delay distribution

We again retrieve the appropriate distribution from @linton2020 using the `epidist_db()` function from the _epiparameter_ package.

```{r message = FALSE, warning = FALSE, eval = TRUE}
onset_to_death_covid <- epidist_db(
  disease = "COVID-19",
  epi_dist = "onset_to_death",
  author = "Linton_etal",
  single_epidist = TRUE
)
```

### Estimating incidence of cases with a known death outcome

We use the same method and implementation as in the Ebola example to calculate the number of known death outcomes over time.

```{r}
df_known_outcomes_covid <- known_outcomes(
  data = df_covid_uk_subset,
  epidist = onset_to_death_covid
)
```

```{r fig.cap = "The case time series for the ongoing COVID-19 epidemic in the U.K., with estimated known death outcomes included.", class.source = 'fold-hide'}
ggplot(df_known_outcomes_covid) +
  geom_step(
    aes(
      x = date, y = cases,
      colour = "Cases"
    )
  ) +
  geom_step(
    aes(
      x = date, y = known_outcomes,
      colour = "Known death outcomes"
    )
  ) +
  scale_colour_manual(
    values = c(
      "Cases" = "steelblue",
      "Known death outcomes" = "darkgreen"
    ),
    name = NULL
  ) +
  scale_x_date(
    date_labels = "%d-%b-%Y"
  ) +
  scale_y_continuous(
    labels = comma
  ) +
  theme(
    legend.position = "top"
  ) +
  labs(
    x = "Date", y = "No. of individuals"
  ) +
  coord_cartesian(
    expand = FALSE
  ) +
  theme_classic() +
  theme(legend.position = "top")
```

### Estimating the naive and corrected CFR

Finally, we calculate the naive and corrected CFRs for the COVID-19 epidemic in
the U.K.

```{r message = FALSE, warning = FALSE, eval = TRUE}
# calculating the naive CFR
cfr_static(
  df_covid_uk_subset
)

# calculating the corrected CFR
cfr_static(
  df_covid_uk_subset,
  epidist = onset_to_death_covid
)
```

---

## Details: Adjusting for delays between two time series

The method used in `cfr_static()` function follows @nishiura2009.
The function calculates a quantity $u_t$ for each day within the input data, which represents the proportion of cases with a known outcome, on day $t$.
This may be a known death outcome, as shown earlier in this vignette.
Following Nishiura et al., $u_t$ is calculated in the following way:

\begin{equation}
  u_t = \frac{\sum_{i = 0}^t
        \sum_{j = 0}^\infty c_i f_{j - i}}{\sum_{i = 0} c_i},
\end{equation}

where $f_t$ is the value of the probability mass function at time $t$ and $c_t$, $d_t$ are the number of new cases and new deaths at time $t$, (respectively).
We then use $u_t$ at the end of the outbreak in the following likelihood function to estimate the severity of the disease in question.

\begin{equation}
  L(\theta | y) = \log{\binom{u_tC}{D}} + D \log{\theta} +
  (u_tC - D)\log{(1.0 - \theta)},
\end{equation}

$C$ and $D$ are the cumulative number of cases and deaths (respectively) up until time $t$.
Lastly, $\theta$ is the parameter we wish to estimate, the severity of the disease.
We estimate $\theta$ using simple maximum-likelihood methods, allowing the functions within this package to be quick and easy tools to use.

The precise severity measure — CFR, IFR, HFR, etc — that $\theta$ represents depends upon the input data given by the user.
For complete clarity, here are the most common time series that users might calculate severity from and the resulting severity estimate from such data.

 - Case and death incidence data, with a case-to-death delay distribution (or close approximation, such as onset-to-death) — Case Fatality Risk (CFR).

 - Infection and death incidence data, with an exposure-to-death delay distribution (or close approximation).

 - Hospitalisation Fatality Risk (HFR) --- Hospitalisation and death incidence data, delay distribution (or close approximation).

---

## References
