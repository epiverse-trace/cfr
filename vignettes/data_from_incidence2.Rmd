---
title: "Handling data from {incidence2}"
output:
  bookdown::html_vignette2:
    fig_caption: yes
    code_folding: show
pkgdown:
  as_is: true
vignette: >
  %\VignetteIndexEntry{Handling data from {incidence2}}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

This vignette shows how to prepare `<incidence2>` objects from the [_incidence2_ package](https://www.reconverse.org/incidence2/) for use with _cfr_, using the `prepare_data()` method for the `<incidence2>` class.

We first load the libraries we require, including _cfr_, _incidence2_, [_outbreaks_](https://www.reconverse.org/outbreaks/) for linelist data from a simulated ebola outbreak, and [_epiparameter_](https://epiverse-trace.github.io/epiparameter/) for delay distribution data.

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```

```{r setup}
library(cfr)

# load {incidence2}
library(incidence2)

# load {outbreaks} for ebola data
library(outbreaks) # nolint

# load {epiparameter} for delay distributions
library(epiparameter)

# packages to wrangle data
library(dplyr)
```

# `<incidence2>` objects from linelists

We first load some linelist data for the 2014 Ebola outbreak provided with the _outbreaks_ package, and create an _incidence2_ object and view it.

```{r}
# load ebola dataset from outbreak
data("ebola_sim_clean")
ebola <- ebola_sim_clean$linelist

# view ebola
head(ebola)
```

We then prepare an `<incidence2>` object using the `date_of_onset` and `date_of_outcome` columns as the date indices, and grouping by outcome.

These steps use a combination of functions from _incidence2_ as well as common data science packages such as [_dplyr_](https://dplyr.tidyverse.org/).

```{r}
# create incidence2 object of ebola deaths
ebola <- incidence(
  x = ebola,
  date_index = c(
    onset = "date_of_onset",
    outcome = "date_of_outcome"
  ),
  groups = "outcome"
)

# filter for outcomes that are deaths using dplyr::filter --- death counts
# also filter for all onsets --- these are the case counts
ebola <- filter(
  ebola,
  (outcome == "Death" & count_variable == "outcome") |
    (count_variable == "onset")
)

# remove groups using incidence2::regroup()
ebola <- regroup(ebola)

# prepare data
ebola <- prepare_data(
  ebola,
  cases_variable = "onset",
  deaths_variable = "outcome",
  fill_NA = TRUE
)
```

In this example, we used the `fill_NA` argument and set it to `TRUE`; this replaces missing case and death counts in the data with `0`s.
The default value of this argument is `FALSE`, however, keeping `NA`s in the data causes downstream issues with functions such as `estimate_static()`.
We recommend that users should carefully consider whether they can safely fill `NA`s with zeros for the purposes of their analysis.

We then load a delay distribution from the _epiparameter_ database as an `<epidist>` object.

```{r}
onset_to_death_ebola <- epidist_db(
  disease = "Ebola Virus Disease",
  epi_dist = "onset_to_death",
  author = "Barry_etal"
)
```

Finally, we estimate the static case fatality rate while correcting for delays suing the `estimate_static()` function.

```{r}
# estimate static CFR as a sanity check
estimate_static(
  ebola,
  correct_for_delays = TRUE, epidist = onset_to_death_ebola
)
```

## `<incidence2>` objects from aggregated case data

Aggregated case data such as the Covid-19 dataset provided by _incidence2_ can be used with _cfr_ directly.

Such usage is shown in other vignettes such as the [vignette on estimating time-varying severity](estimate_time_varying_severity.html).

Here we show how to transform such data into `<incidence2>` objects, and then prepare them for _cfr_.

The columns in this dataset are already in a format that can be converted into an `<incidence2>` object using `incidence2::incidence()`, and then handled by `prepare_data()`.
The code chunks below show how this is to be done.

```{r}
# get data bundled with the {incidence2} package
covid_uk <- covidregionaldataUK

# view the data
head(covid_uk)
```

Note that the grouping structure of this dataset given by the "region" variable is present in the `<incidence2>` object, but is overridden to provide a single dataset with cases and deaths summed across regions by date by `prepare_data()`.
This functionality is currently under development and might change in future.

```{r}
# convert to incidence2 object
covid_uk_incidence <- incidence(
  covid_uk,
  date_index = "date",
  counts = c("cases_new", "deaths_new"),
  count_names_to = "count_variable"
)

# View head of prepared data
head(
  prepare_data(
    covid_uk_incidence,
    cases_variable = "cases_new",
    deaths_variable = "deaths_new",
    fill_NA = TRUE
  )
)
```
