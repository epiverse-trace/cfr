---
title: "Estimating how disease severity varies over the course of an outbreak"
output:
  bookdown::html_vignette2:
    fig_caption: yes
    code_folding: show
pkgdown:
  as_is: true
bibliography: resources/library.json
link-citations: true
vignette: >
  %\VignetteIndexEntry{Estimating how disease severity varies over the course of an outbreak}
  %\VignetteEncoding{UTF-8}
  %\VignetteEngine{knitr::rmarkdown}
editor_options: 
  chunk_output_type: console
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>",
  dpi = 300,
  fig.width = 5, fig.height = 3
)
```

There are many biological, epidemiological and behavioural reasons why the severity of a disease might change during the course of an outbreak, including the introduction of vaccines or therapeutics, reducing the relative risk of death, or the emergence of pathogen variants, which may alter the risk of hospitalisation or death associated with infection.

Running the `cfr_static()` function on datasets corresponding to different stages of the outbreak would lead to two static estimates, which may or may not differ.
This could be useful, but a more detailed and easier to interpret approach is to use the function demonstrated in this vignette, `cfr_time_varying()`.

This vignette outlines how to use _cfr_ to estimate how the severity of a disease changes over the course of an ongoing outbreak.

::: {.alert .alert-warning}
New to calculating disease severity using _cfr_? You might want to see the ["Get started" vignette first](cfr.html).
:::

::: {.alert .alert-primary}
## Use case {-}

We wish to estimate how common severity quantities _change over time_ --- such as the case fatality risk (CFR) --- using a method that uses a time series of cases, infections or hospitalisations (as appropriate) and deaths, _while correcting for the delay in reporting the outcomes of cases_.
:::

::: {.alert .alert-secondary}
### What we have {-}

* A time-series of cases, hospitalisations or some other proxy for infections over time;
* A time-series of deaths;
* A delay distribution, describing the probability an individual will die $t$ days after they were initially infected.

The first two elements are expected be included in a dataframe with the columns "dates", "cases", and "deaths".

The delay distribution is expected to be specified as an object of the class `<epidist>` from the package [_epiparameter_](https://epiverse-trace.github.io/epiparameter/).
:::

First load _cfr_ and packages to access and plot data.

```{r, message = FALSE, warning=FALSE, eval = TRUE}
library(cfr)

# packages to access delay data and case data
library(epiparameter)

# packages to wrangle and plot data
library(dplyr)
library(tidyr)
library(purrr)
library(scales)
library(ggplot2)
```

The `cfr_time_varying()` function requires a `data.frame` of input data --- typically case and death time series data --- and a delay distribution.
The delay distribution we use here comes from the [_epiparameter_ package](https://epiverse-trace.github.io/epiparameter/).

## Changing severity of the COVID-19 pandemic in the U.K.

We outline how the time-varying severity estimation works in *cfr* using a number of examples.
The data for all of the examples is from the ongoing COVID-19 epidemic.
Firstly, we analyse the U.K. data, then we pick three other countries with large outbreaks to analyse. 

### Preparing the raw data

First we subset the data so that we focus on just the first year of the COVID-19 outbreak in the U.K.
During this period, the CFR changed dramatically as a result of a number of changes in policy, such as implementation and relaxation of lockdown, rollout of the vaccine, new variants emerging, etc.

We load Covid-19 daily case and death data for 19 countries with ≥ 100,000 deaths between 2020 and 2023 --- this data is provided with the _cfr_ package as `covid_data`, and was initially made available in the [_covidregionaldata_ package](https://github.com/epiforecasts/covidregionaldata) [@palmer2021], which is no longer available on CRAN.

```{r}
# get Covid data loaded with the package
data("covid_data")

# filter for the U.K
df_covid_uk <- filter(covid_data, country == "United Kingdom")
```

We then subset the data to focus on just the first few months of the outbreak.

```{r}
df_covid_uk_subset <- filter(df_covid_uk, date <= "2020-12-31")
```

Then, we plot case incidence data.
Further plotting commands are hidden for brevity.

```{r, fig.cap = "Incidence of cases over time for the ongoing COVID-19 outbreak in the U.K."}
ggplot(df_covid_uk_subset) +
  geom_step(
    aes(
      x = date, y = cases
    ),
    colour = "steelblue"
  ) +
  scale_x_date(
    date_labels = "%b-%Y"
  ) +
  scale_y_continuous(
    labels = comma
  ) +
  labs(
    x = "Date", y = "Cases"
  ) +
  coord_cartesian(
    expand = FALSE
  ) +
  theme_classic() +
  theme(legend.position = "top")
```

We also plot the death incidence data over time.

```{r, fig.cap = "Incidence of deaths over time for the ongoing COVID-19 outbreak in the U.K.", class.source = 'fold-hide'}
ggplot(df_covid_uk_subset) +
  geom_step(
    aes(
      x = date, y = deaths
    ),
    colour = "brown"
  ) +
  scale_x_date(
    date_labels = "%b-%Y"
  ) +
  scale_y_continuous(
    labels = comma
  ) +
  labs(
    x = "Date", y = "Deaths"
  ) +
  coord_cartesian(
    expand = FALSE
  ) +
  theme_classic() +
  theme(legend.position = "top")
```

### Onset-to-death distribution for Covid-19

We retrieve the appropriate distribution reported in @linton2020 using the `epidist_db()` function from the _epiparameter_ package.

```{r message=FALSE, warning=FALSE, eval=TRUE}
onset_to_death_covid <- epidist_db(
  disease = "COVID-19",
  epi_dist = "onset_to_death",
  author = "Linton_etal",
  single_epidist = TRUE
)
```

### Estimating the naive and corrected CFR

We use the `cfr_time_varying()` function within the _cfr_ package to calculate the time-varying CFR for the COVID-19 epidemic in the U.K.

```{r}
# calculating the naive time-varying CFR
df_covid_cfr_uk_naive <- cfr_time_varying(
  df_covid_uk_subset,
  epidist = onset_to_death_covid,
  smooth_inputs = TRUE,
  burn_in_value = 7,
  correct_for_delays = FALSE
)

# calculating the corrected time-varying CFR
df_covid_cfr_uk_corrected <- cfr_time_varying(
  df_covid_uk_subset,
  epidist = onset_to_death_covid,
  smooth_inputs = TRUE,
  burn_in_value = 7,
  correct_for_delays = TRUE
)
```

Once we have calculated both severity quantities over time, we plot the results; first the naive estimate.

```{r, fig.cap = "Example plot of the naive time-varying CFR. We calculate the time-varying CFR for the ongoing COVID-19 epidemic in the U.K., uncorrected for delays. The red line shows the CFR estimate while the shaded grey region shows the lower and upper limits of the estimate as 95% confidence intervals.", class.source = 'fold-hide'}
ggplot(df_covid_cfr_uk_naive) +
  geom_ribbon(
    aes(
      x = date, ymin = severity_low, ymax = severity_high
    ),
    fill = "grey75"
  ) +
  geom_line(
    aes(
      x = date, y = severity_mean
    ),
    colour = "brown"
  ) +
  scale_x_date(
    date_labels = "%b-%Y"
  ) +
  scale_y_continuous(
    labels = percent
  ) +
  labs(
    x = "Date", y = "CFR (%)"
  ) +
  coord_cartesian(
    expand = FALSE
  ) +
  theme_classic() +
  theme(legend.position = "top")
```

Lastly, we plot the estimate corrected for reporting delays.

```{r, fig.cap = "Example plot of the corrected time-varying CFR.** We calculate the time-varying CFR for the ongoing COVID-19 epidemic in the U.K., corrected for delays. The red line shows the CFR estimate while the shaded grey region shows the lower and upper limits of the estimate as 95% confidence intervals.", class.source = 'fold-hide'}
ggplot(df_covid_cfr_uk_corrected) +
  geom_ribbon(
    aes(
      x = date, ymin = severity_low, ymax = severity_high
    ),
    fill = "grey75"
  ) +
  geom_line(
    aes(
      x = date, y = severity_mean
    ),
    colour = "brown"
  ) +
  scale_x_date(
    date_labels = "%b-%Y"
  ) +
  scale_y_continuous(
    labels = percent
  ) +
  labs(
    x = "Date", y = "CFR (%)"
  ) +
  coord_cartesian(
    expand = FALSE
  ) +
  theme_classic() +
  theme(legend.position = "top")
```

## Severity of COVID-19 in multiple countries

We now show how to calculate the time-varying CFR for Covid-19 in multiple countries with large outbreaks.
To do this, we adopt a data science approach to apply the `cfr_time_varying()` function across data grouped by country.
We refer the user to the book [R for Data Science](https://r4ds.had.co.nz/) for a better explanation of some of the code used here, including from the packages in [the Tidyverse](https://www.tidyverse.org/).

We use the larger Covid-19 cases and deaths data provided with the package as `covid_data`.
We exclude four countries which only provide weekly data (with zeros for dates in between) --- France, Germany, Spain and Ukraine.

Next, we group the data by country and apply the `cfr_time_varying()` function across each group (country).
This code takes a few moments to run.

```{r}
# countries with weekly reporting
weekly_reporting <- c("France", "Germany", "Spain", "Ukraine")
covid_data <- filter(covid_data, !country %in% weekly_reporting)

# for each country, get the time-varying severity estimate,
# correcting for delays and smoothing the case and death data

# first nest the data; nest() from {tidyr}
df_covid_cfr <- nest(
  covid_data,
  .by = country
)
```

```{r}
# to each nested data frame, apply the function `cfr_time_varying`
# overwrite the `data` column, as all data will be preserved
df_covid_cfr <- mutate(
  df_covid_cfr,
  # using map() from {purrr}
  data = map(
    .x = data, .f = cfr_time_varying,
    # arguments to the function
    epidist = onset_to_death_covid, smooth_inputs = TRUE,
    smoothing_window = 7, burn_in_value = 7
  )
)

# unnest the cfr data; unnest() from {tidyr}
df_covid_cfr <- unnest(df_covid_cfr, cols = data)
```

For simplicity, we use the same delay distribution between onset and death for all countries.

Finally we plot the time-varying CFR for a selection of three more countries with large outbreaks of COVID-19: Brazil, India, and the United States.

```{r, fig.cap = "Example plot of the corrected time-varying CFR. We calculate the time-varying CFR for the ongoing COVID-19 epidemic in Brazil, India, and the United States, corrected for delays.", class.source = 'fold-hide', fig.width=8}
filter(df_covid_cfr, country %in% c("Brazil", "India", "United States")) %>%
  ggplot() +
  geom_ribbon(
    aes(
      x = date, ymin = severity_low, ymax = severity_high,
      group = country
    ),
    fill = "grey"
  ) +
  geom_line(
    aes(
      x = date, y = severity_mean, colour = country
    )
  ) +
  scale_x_date(
    date_labels = "%b-%Y"
  ) +
  scale_y_continuous(
    labels = percent
  ) +
  scale_colour_brewer(
    palette = "Dark2"
  ) +
  labs(
    x = "Date", y = "CFR (%)"
  ) +
  coord_cartesian(
    ylim = c(0, 0.15),
    expand = FALSE
  ) +
  theme_classic() +
  theme(legend.position = "top")
```

---

## Details: Adjusting for delays between two time series 

The function `cfr_time_varying()` from the _cfr_ package estimates the number of cases which have a known outcome over time, following @nishiura2009.
The function calculates a quantity $k_t$ for each day within the input data, which represents the number of cases with a known outcome, on day $t$.
This may be a known death outcome, as shown earlier in this vignette.
Following @nishiura2009, $k_t$ is calculated in the following way:

\begin{equation}
  k_t = \sum_{j = 0}^t c_t f_{j - t}.
\end{equation}

We then assume that the severity measure, for example CFR, of interest is
binomially distributed, in the following way 

\begin{equation}
  d_t \sim \text{Binomial}(k_t, \theta_t). 
\end{equation}

We use maximum likelihood estimation to determine the value of $\theta_t$ for 
each $t$, where $\theta$ represents the severity measure of interest.

The precise severity measure — CFR, IFR, HFR, etc — that $\theta$ represents depends upon the input data given by the user.

---

## References
