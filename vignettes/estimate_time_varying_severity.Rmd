---
title: "Estimating how disease severity varies over the course of an outbreak"
output:
  bookdown::html_vignette2:
    fig_caption: yes
    code_folding: show
pkgdown:
  as_is: true
bibliography: resources/library.json
link-citations: true
vignette: >
  %\VignetteIndexEntry{Estimating how disease severity varies over the course of an outbreak}
  %\VignetteEncoding{UTF-8}
  %\VignetteEngine{knitr::rmarkdown}
editor_options: 
  chunk_output_type: console
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>",
  dpi = 300,
  fig.width = 5, fig.height = 3
)
```

There are many biological, epidemiological and behavioural reasons why the severity of a disease might change during the course of an outbreak, including the introduction of vaccines or therapeutics, reducing the relative risk of death, or the emergence of pathogen variants, which may alter the risk of hospitalisation or death associated with infection.

Estimating the severity of an outbreak that has undergone substantial changes is of critical importance for surveillance and planning purposes.
Running the `estimate_static()` function on datasets corresponding to different stages of the outbreak would lead to two static estimates, which may or may not differ.
This could be useful, but a more detailed and easier to interpret approach is to use the function demonstrated in this vignette, `estimate_time_varying()`.

This vignette outlines how to use _cfr_ to estimate how the severity of a disease changes over the course of an ongoing outbreak.

::: {.alert .alert-warning}
New to calculating disease severity using _cfr_? You might want to see the ["Get started" vignette first](cfr.html).
:::

::: {.alert .alert-primary}
## Use case {-}

We wish to estimate how common severity quantities _change over time_ --- such as the case fatality risk (CFR) --- using a method that uses a time series of cases, infections or hospitalisations (as appropriate) and deaths, _while correcting for the delay in reporting the outcomes of cases_.
:::

::: {.alert .alert-secondary}
## What we have {-}

* A time-series of cases, hospitalisations or some other proxy for infections over time;
* A time-series of deaths;
* A delay distribution, describing the probability an individual will die $t$ days after they were initially infected.
:::

First load _cfr_ and packages to access and plot data.

```{r, message = FALSE, warning=FALSE, eval = TRUE}
library(cfr)

# packages to access delay data and case data
library(epiparameter)
library(owidR)

# packages to wrangle and plot data
library(dplyr)
library(tidyr)
library(purrr)
library(scales)
library(ggplot2)
```

The `estimate_time_varying()` function requires a `data.frame` of input data --- typically case and death time series data --- and a delay distribution.
The delay distribution we use here comes from the [_epiparameter_ package](https://epiverse-trace.github.io/epiparameter/).

## Changing severity of the COVID-19 pandemic in the U.K.

We outline how the time-varying severity estimation works in *cfr* using a number of examples.
The data for all of the examples is from the ongoing COVID-19 epidemic.
Firstly, we analyse the U.K. data, then we pick three other countries with large outbreaks to analyse. 

### Preparing the raw data

First we subset the data so that we focus on just the first year of the COVID-19 outbreak in the U.K.
During this period, the CFR changed dramatically as a result of a number of changes in policy, such as implementation and relaxation of lockdown; rollout of the vaccine; new variants emerging, etc.

We load the [global Covid-19 dataset collected by Our World in Data](https://ourworldindata.org/coronavirus), and provided through the [_owidR_ package](https://cran.r-project.org/package=owidR).

We introduce this dataset here, rather than its more U.K. focused equivalent from the _incidence2_ package, because we are going to use it further on for other countries.

```{r}
# get Covid data from {owidR}
df_covid <- owid_covid()

# filter for the U.K
df_covid_uk <- filter(df_covid, location == "United Kingdom")

# select and rename columns wth {dplyr}
df_covid_uk <- select(
  df_covid_uk, date,
  cases = new_cases, deaths = new_deaths
)
```

We then subset the data to focus on just the first few months of the outbreak.

```{r}
df_covid_uk_subset <- filter(df_covid_uk, date <= "2020-12-31")
```

Then, we plot case incidence data with following command.
Further plotting commands are hidden for brevity.

```{r, fig.cap = "Incidence of cases over time for the ongoing COVID-19 outbreak in the U.K."}
ggplot(df_covid_uk_subset) +
  geom_step(
    aes(
      x = date, y = cases
    ),
    colour = "steelblue"
  ) +
  scale_x_date(
    date_labels = "%b-%Y"
  ) +
  scale_y_continuous(
    labels = comma
  ) +
  labs(
    x = "Date", y = "Cases"
  )
```

We also plot the death incidence data over time.

```{r, fig.cap = "Incidence of deaths over time for the ongoing COVID-19 outbreak in the U.K.", class.source = 'fold-hide'}
ggplot(df_covid_uk_subset) +
  geom_step(
    aes(
      x = date, y = deaths
    ),
    colour = "brown"
  ) +
  scale_x_date(
    date_labels = "%b-%Y"
  ) +
  scale_y_continuous(
    labels = comma
  ) +
  labs(
    x = "Date", y = "Deaths"
  )
```

### Onset-to-death distribution for Covid-19

We retrieve the appropriate distribution reported in @linton2020 using the `epidist_db()` function from the _epiparameter_ package.

```{r message=FALSE, warning=FALSE, eval=TRUE}
onset_to_death_covid <- epidist_db(
  disease = "COVID-19",
  epi_dist = "onset_to_death",
  author = "Linton_etal"
)
```

To visualise this distribution, we evaluate it between 0 and 30 days, and plot the results over time.

```{r message=FALSE, warning=FALSE, eval=TRUE, fig.cap = "Example plot of the appropriate delay distribution for the COVID-19 epidemic in the U.K. We plot the onset-to-death distribution we use throughout this example for COVID-19, reported in @linton2020."}
plot(onset_to_death_covid, day_range = seq(30), cex.main = 0.5)
```

### Estimating the naive and corrected CFR

We use the `estimate_time_varying()` function within the _cfr_ package to calculate the time-varying CFR for the COVID-19 epidemic in the U.K.

```{r}
# calculating the naive time-varying CFR
df_covid_cfr_uk_naive <- estimate_time_varying(
  df_covid_uk_subset,
  epi_dist = onset_to_death_covid,
  smooth_inputs = TRUE,
  burn_in = 7,
  correct_for_delays = FALSE
)

# calculating the corrected time-varying CFR
df_covid_cfr_uk_corrected <- estimate_time_varying(
  df_covid_uk_subset,
  epi_dist = onset_to_death_covid,
  smooth_inputs = TRUE,
  burn_in = 7,
  correct_for_delays = TRUE
)
```

Once we have calculated both severity quantities over time, we plot the results; first the naive estimate.

```{r, fig.cap = "Example plot of the naive time-varying CFR.** We calculate the time-varying CFR for the ongoing COVID-19 epidemic in the U.K., uncorrected for delays.", class.source = 'fold-hide'}
ggplot(df_covid_cfr_uk_naive) +
  geom_ribbon(
    aes(
      x = date, ymin = severity_lo, ymax = severity_hi
    ),
    fill = "grey75"
  ) +
  geom_line(
    aes(
      x = date, y = severity_me
    ),
    colour = "brown"
  ) +
  scale_x_date(
    date_labels = "%b-%Y"
  ) +
  scale_y_continuous(
    labels = percent
  ) +
  labs(
    x = "Date", y = "CFR (%)"
  )
```

Lastly, we plot the estimate corrected for reporting delays.

```{r, fig.cap = "Example plot of the corrected time-varying CFR.** We calculate the time-varying CFR for the ongoing COVID-19 epidemic in the U.K., corrected for delays.", class.source = 'fold-hide'}
ggplot(df_covid_cfr_uk_corrected) +
  geom_ribbon(
    aes(
      x = date, ymin = severity_lo, ymax = severity_hi
    ),
    fill = "grey75"
  ) +
  geom_line(
    aes(
      x = date, y = severity_me
    ),
    colour = "brown"
  ) +
  scale_x_date(
    date_labels = "%b-%Y"
  ) +
  scale_y_continuous(
    labels = percent
  ) +
  labs(
    x = "Date", y = "CFR (%)"
  )
```

## Severity of COVID-19 in multiple countries

We now show how to calculate the time-varying CFR for Covid-19 in multiple countries with large outbreaks.
To do this, we adopt a data science approach to apply the `estimate_time_varying()` function across data grouped by country.
We refer the user to the book [R for Data Science](https://r4ds.had.co.nz/) for a better explanation of some of the code used here, including from the packages in [the Tidyverse](https://www.tidyverse.org/).

First we retrieve daily case and death data for COVID-19 for all countries and locations from the `owidR` package.

```{r}
# get data from {owidR}
df_covid <- owid_covid()

# filter out whole continents
df_covid <- filter(
  df_covid, location != continent
)

# rename the cases and deaths columns using {dplyr}
df_covid <- select(
  df_covid, iso_code, location, continent, date,
  cases = new_cases, deaths = new_deaths,
  total_deaths
)
```

Next, we group the data by country and apply the `estimate_time_varying()` function across each group (country).
This code takes a few moments to run.

```{r}
# get the total number of deaths in each country with more than 100,000 deaths
df_covid_cfr <- df_covid %>%
  group_by(iso_code) %>%
  mutate(total_deaths = max(total_deaths, na.rm = TRUE)) %>%
  filter(total_deaths > 100000 & !is.na(location)) %>%
  ungroup()

# for each country, get the time-varying severity estimate,
# correcting for delays and smoothing the case and death data

# first nest the data; nest() from {tidyr}
df_covid_cfr <- nest(
  df_covid_cfr,
  .by = location
)
```

```{r}
# to each nested data frame, apply the function `estimate_time_varying`
# overwrite the `data` column, as all data will be preserved
df_covid_cfr <- mutate(
  df_covid_cfr,
  # using map() from {purrr}
  data = map(
    .x = data, .f = estimate_time_varying,
    # arguments to the function
    epi_dist = onset_to_death_covid, smooth_inputs = TRUE,
    smoothing_window = 7, burn_in = 7
  )
)

# unnest the cfr data; unnest() from {tidyr}
df_covid_cfr <- unnest(df_covid_cfr, cols = data)
```

For simplicity, we use the same delay distribution between onset and death for all locations.

Finally we plot the time-varying CFR for a selection of three more countries with large outbreaks of COVID-19: Brazil, India, and the United States.

```{r, fig.cap = "Example plot of the corrected time-varying CFR. We calculate the time-varying CFR for the ongoing COVID-19 epidemic in Brazil, India, and the United States, corrected for delays.", class.source = 'fold-hide', fig.width=8}
filter(df_covid_cfr, location %in% c("Brazil", "India", "United States")) %>%
  ggplot() +
  geom_ribbon(
    aes(
      x = date, ymin = severity_lo, ymax = severity_hi,
      group = location
    ),
    fill = "grey"
  ) +
  geom_line(
    aes(
      x = date, y = severity_me, colour = location
    )
  ) +
  scale_x_date(
    date_labels = "%b-%Y"
  ) +
  scale_y_continuous(
    labels = percent
  ) +
  scale_colour_brewer(
    palette = "Dark2"
  ) +
  coord_cartesian(
    ylim = c(0, 0.2),
    expand = FALSE
  ) +
  labs(
    x = "Date", y = "CFR (%)"
  ) +
  theme(
    legend.position = "top"
  )
```

## Details: Adjusting for delays between two time series {-}

The function `estimate_time_varying()` from the _cfr_ package estimates the number of cases which have a known outcome over time, following @nishiura2009.
The function calculates a quantity $k_t$ for each day within the input data, which represents the number of cases with a known outcome, on day $t$.
Following @nishiura2009, $k_t$ is calculated in the following way:

\begin{equation}
  k_t = \sum_{j = 0}^t c_t f_{j - t}.
\end{equation}

We then assume that the severity measure, for example CFR, of interest is
Binomially-distributed, in the following way 

\begin{equation}
  d_t \sim \text{Binomial}(k_t, \theta_t). 
\end{equation}

We use maximum-likelihood techniques to determine the value of $\theta_t$ for 
each $t$, whereby $\theta$ represents the severity measure of interest.

The precise severity measure — CFR, IFR, HFR, etc — that $\theta$ represents depends upon the input data given by the user.

## References
